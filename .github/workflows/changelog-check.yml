# **what?**
# Checks that a file has been committed under the /.changes directory
# as a new CHANGELOG entry.  Cannot check for a specific filename as
# it is dynamically generated by change type and timestamp.
# This workflow should not require any secrets since it runs for PRs
# from forked repos.
# By default, secrets are not passed to workflows running from
# a forked repo.

# **why?**
# Ensure code change gets reflected in the CHANGELOG.

# **when?**
# This will run for all PRs going into main and *.latest.  It will
# run when they are opened, reopened, when any label is added or removed
# and when new code is pushed to the branch.  The action will then get
# skipped if the 'Skip Changelog' label is present is any of the labels.

name: Check Changelog Entry

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]
  workflow_dispatch:

defaults:
  run:
    shell: bash

permissions:
  contents: read
  pull-requests: write

env:
  changelog_comment: 'Thank you for your pull request! We could not find a changelog entry for this change. For details on how to document a change, see [the contributing guide](https://github.com/dbt-labs/dbt-core/blob/main/CONTRIBUTING.md#adding-changelog-entry).'
  skip_label: 'Skip Changelog'

jobs:
  changelog:
    if: "!contains(github.event.pull_request.labels.*.name, 'Skip Changelog')"

    runs-on: ubuntu-latest

    steps:

      - name: "[DEBUG] - Print Inputs"
        shell: bash
        id: echo_inputs
        run: |
          echo "all variables defined as inputs"
          echo "Input Comment Text:        ${{ env.changelog_comment }}"
          echo "Input Label for Skipping:  ${{ env.skip_label }}"

      - name: Determine if changelog exists
        shell: bash
        id: changelog_check
        run: |
          declare RESULT=$(git diff --name-only ${{ github.event.pull_request.head.sha }} ${{ github.event.pull_request.base.sha }})
          if echo $RESULT | grep '.changes/unreleased/**.yaml'; then
            echo "::set-output name=exists::true"
            echo "Changelog exists for this PR"
          else
            echo "::set-output name=exists::false"
            echo "No changelog exists for this PR"
          fi

      # this step uses the read permission from the GITHUB_TOKEN it inherits
      - name: Check for comment
        if: steps.changelog_check.outputs.exists == 'false'
        uses: peter-evans/find-comment@v1
        id: changelog_comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: ${{ env.changelog_comment }}

      - name: Set if comment already exists
        if: steps.changelog_check.outputs.exists == 'false'
        shell: bash
        id: comment_check
        run: |
          if [ '${{ steps.changelog_comment.outputs.comment-body }}' = '' ]; then
            echo "::set-output name=exists::false"
            echo "Comment does not exist for this PR"
          else
            echo "::set-output name=exists::true"
            echo "Comment already exists for this PR"
          fi

      # this step uses the write permission on the PR from the GITHUB_TOKEN it inherits
      - name: Create PR comment if changelog entry is missing, required, and does not exist
        if: |
          steps.changelog_check.outputs.exists == 'false' &&
          steps.comment_check.outputs.exists == 'false'
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ env.changelog_comment }}

      - name: Fail job if changelog entry is missing and required
        if: steps.changelog_check.outputs.exists == 'false'
        uses: actions/github-script@v6
        with:
          script: core.setFailed('Changelog entry required to merge.')
